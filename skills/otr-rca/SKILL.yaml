# OTR RCA Skill Definition
# Root Cause Analysis for ground (OTR) tracking issues
# Based on: Carrier/OTR Operations (Prashant workflow - Jan 14, 2026)
# Source: PRASHANT_SESSION_PREP.md, SUPPORT-TEAM-MENTAL-MODEL.md

skill:
  id: "otr_rca"
  name: "OTR Tracking & Operations RCA"
  version: "1.0.0"
  author: "FourKites AI R&D / MSP Raja"
  category: "support-operations"
  domain: "otr"
  status: "poc"
  created: "2026-01-14"

  description: |
    Root Cause Analysis for ground (OTR) tracking issues including:
    - Load not tracking / no GPS updates
    - ELD not enabled or offline
    - Network relationships missing between carrier and shipper
    - GPS/location issues (null coordinates, stale timestamps)
    - Carrier API failures or misconfiguration
    - Callback delivery failures
    - Device/ELD configuration errors
    - Late load assignments or tracking delays
    - Carrier not configured for tracking

    Mental Model: "Check platform, verify ELD config, trace data sources,
    correlate findings across logs to identify carrier/system/config issues"

  # When Router Should Invoke This Skill
  triggers:
    keywords:
      - "load not tracking"
      - "no GPS"
      - "no position"
      - "positions not showing"
      - "tracking stopped"
      - "no ELD"
      - "ELD offline"
      - "ELD not enabled"
      - "no updates"
      - "network relationship"
      - "callback failure"
      - "carrier not configured"
      - "GPS null"
      - "late assignment"
      - "stale location"
      - "over the road"
      - "OTR"
      - "ground"
      - "ltl"
      - "ftl"
      - "device config"

    issue_categories:
      - "tracking_not_working"
      - "eld_offline"
      - "network_missing"
      - "gps_failure"
      - "carrier_api_failure"
      - "callback_failure"
      - "late_assignment"
      - "device_configuration"

    conditions:
      - "load.mode == 'OTR'"
      - "load.mode == 'GROUND'"
      - "load.mode == 'LTL'"
      - "load.mode == 'FTL'"
      - "issue.type matches 'tracking.*issue'"

  # What This Skill Can Do (Capabilities)
  capabilities:

    - id: "platform_check"
      name: "Platform Check (Customer View)"
      description: |
        First look - see what customer sees.
        Check load existence, current state, tracking status, last position update.
      confidence: "high"
      time_estimate: "2-3 minutes"
      tools:
        - "fourkites_platform"
        - "tracking_api"
      outputs:
        - "load_exists"
        - "current_state"
        - "tracking_enabled"
        - "last_position_update"
        - "last_position_coordinates"
        - "update_timestamp"

    - id: "eld_configuration_check"
      name: "ELD Configuration & Status Check"
      description: |
        Verify ELD is enabled, device is online, and carrier configured correctly.
        Check device mapping and ELD vendor integration.
      confidence: "high"
      time_estimate: "3-5 minutes"
      tools:
        - "tracking_api"
        - "company_api"
      outputs:
        - "eld_enabled"
        - "eld_device_id"
        - "eld_vendor"
        - "device_online_status"
        - "last_heartbeat"
        - "carrier_eld_config"

    - id: "network_relationship_check"
      name: "Network Relationship Verification"
      description: |
        Verify carrier-shipper relationship exists and is active.
        Check if tracking permission is granted for this carrier.
      confidence: "high"
      time_estimate: "2-3 minutes"
      tools:
        - "company_api"
        - "redshift"
      outputs:
        - "relationship_exists"
        - "relationship_active"
        - "tracking_enabled"
        - "carrier_config_complete"

    - id: "carrier_api_health_check"
      name: "Carrier API Integration Health"
      description: |
        Check carrier API endpoint status, authentication, and recent data flow.
        Verify carrier is sending updates.
      confidence: "high"
      time_estimate: "3-5 minutes"
      tools:
        - "signoz_logs"
        - "tracking_api"
      outputs:
        - "api_status"
        - "auth_working"
        - "recent_updates_received"
        - "api_error_rate"
        - "last_successful_call"

    - id: "gps_location_analysis"
      name: "GPS/Location Data Analysis"
      description: |
        Deep dive into GPS coordinates, timestamps, and location history.
        Identify null coordinates, stale data, or location jumps.
      confidence: "medium"
      time_estimate: "5-10 minutes"
      tools:
        - "signoz_logs"
        - "redshift"
      outputs:
        - "coordinate_validity"
        - "timestamp_freshness"
        - "location_sequence"
        - "anomalies_detected"

    - id: "callback_delivery_check"
      name: "Callback/Webhook Delivery Analysis"
      description: |
        Verify callbacks are being delivered to customer system.
        Check endpoint health and delivery status.
      confidence: "medium"
      time_estimate: "5-8 minutes"
      tools:
        - "signoz_logs"
        - "tracking_api"
      outputs:
        - "callback_endpoint_configured"
        - "endpoint_reachable"
        - "recent_deliveries"
        - "delivery_failures"
        - "error_details"

    - id: "analyze_signoz_logs"
      name: "Deep Dive into SigNoz Logs"
      description: |
        Analyze tracking worker and device integration logs.
        Identify processing errors, retries, or data transformation issues.
      confidence: "medium"
      time_estimate: "10-15 minutes"
      tools:
        - "signoz_logs"
      outputs:
        - "processed_events"
        - "error_codes"
        - "correlation_ids"
        - "data_sources"
        - "failed_operations"

    - id: "correlate_findings"
      name: "Correlate Findings Across Sources"
      description: |
        Manual correlation across Platform, API, logs, and database.
        Build timeline and identify root cause category.
      confidence: "high"
      time_estimate: "5-10 minutes"
      tools:
        - "correlation_engine"
      outputs:
        - "timeline"
        - "discrepancies"
        - "pattern_match"
        - "root_cause_category"

  # Data Sources (FourKites APIs & Infrastructure)
  data_sources:

    platform:
      name: "FourKites Platform"
      type: "web_ui"
      purpose: "Customer view - load details, tracking status, position history"
      auth: "user_login"
      data_available:
        - "load_details"
        - "current_position"
        - "position_history"
        - "tracking_status"
        - "last_update_time"
        - "carrier_info"
        - "device_info"

    tracking_api:
      name: "Tracking API"
      type: "rest_api"
      endpoint: "${TRACKING_API_URL}"
      auth: "api_key"
      credentials: "env:TRACKING_API_KEY"
      purpose: "Load metadata, real-time tracking, ELD config, device status"
      endpoints:
        - "GET /loads/{load_id}"
        - "GET /loads/{load_id}/positions"
        - "GET /loads/{load_id}/device"
        - "GET /devices/{device_id}/status"
        - "GET /devices/{device_id}/heartbeat"
      data_available:
        - "load_status"
        - "tracking_enabled"
        - "current_position"
        - "last_position_time"
        - "device_id"
        - "device_online"
        - "eld_vendor"
        - "eld_enabled"

    company_api:
      name: "Company API"
      type: "rest_api"
      endpoint: "${COMPANY_API_URL}"
      auth: "api_key"
      credentials: "env:COMPANY_API_KEY"
      purpose: "Carrier relationships, network config, ELD settings"
      endpoints:
        - "GET /companies/{company_id}/relationships"
        - "GET /companies/{company_id}/eld-config"
        - "GET /relationships/{carrier_id}/{shipper_id}"
      data_available:
        - "network_relationships"
        - "relationship_status"
        - "tracking_enabled"
        - "eld_configuration"
        - "carrier_api_config"

    signoz:
      name: "SigNoz (ClickHouse Logs)"
      type: "log_analytics"
      service: "signoz"
      auth: "user_login"
      credentials: "env:SIGNOZ_TOKEN"
      purpose: "Deep dive into processing logs, error tracking, data flow"
      retention: "30 days"
      query_services:
        - "tracking_worker_global"
        - "device_integration_service"
        - "eld_sync_service"
        - "callback_delivery_service"
      query_keywords:
        - "PROCESS_OTR_UPDATE"
        - "DEVICE_UPDATE_FAILED"
        - "ELD_SYNC_ERROR"
        - "GPS_INVALID"
        - "CALLBACK_FAILED"

    redshift:
      name: "Redshift DWH"
      type: "database"
      auth: "aws_iam"
      purpose: "Historical tracking data, pattern analysis, load validation"
      tables:
        - "company_relationships"
        - "fact_device_events"
        - "fact_carrier_updates"
        - "load_validation_data_mart"
        - "tracking_update_v3s"
        - "device_status_snapshots"
      queries_available:
        - "carrier_relationship_status"
        - "device_tracking_history"
        - "callback_delivery_log"
        - "eld_sync_history"

    data_hub_api:
      name: "Data Hub API"
      type: "rest_api"
      endpoint: "${DATA_HUB_URL}"
      purpose: "OTR-specific troubleshooting, quick data aggregation"
      auth: "user_login"
      status: "production"
      data_available:
        - "load_summary"
        - "tracking_status"
        - "device_status"

    s3:
      name: "AWS S3"
      type: "file_storage"
      purpose: "Device logs, ELD raw data, carrier file backups"
      auth: "aws_cli"
      paths:
        - "device-logs/"
        - "eld-data/"
        - "carrier-integrations/"

    cassie:
      name: "CASSIE (Internal Tool)"
      type: "custom_tool"
      purpose: "Carrier lookup, network mapping, API configuration"
      auth: "user_login"
      status: "production"
      data_available:
        - "carrier_capabilities"
        - "api_endpoints"
        - "network_relationships"
        - "integration_status"

    foursight:
      name: "FourSight (Analytics)"
      type: "analytics_platform"
      purpose: "Load patterns, anomaly detection, trend analysis"
      auth: "user_login"
      status: "production"

  # Decision Tree Reference
  decision_tree:
    path: "decision_trees/tracking_issue_classifier.yaml"
    entry_point: "step_1_platform_check"

  # Pattern Definitions
  patterns:
    count: 10
    location: "./patterns/"
    description: "Common issue patterns for OTR tracking"
    files:
      - "eld_not_enabled_network.yaml"
        # Pattern: ELD not enabled + no network relationship
      - "network_relationship_missing.yaml"
        # Pattern: Carrier-shipper relationship doesn't exist
      - "load_not_found.yaml"
        # Pattern: Load ID not found in system
      - "carrier_api_down.yaml"
        # Pattern: Carrier API integration failing
      - "gps_null_timestamps.yaml"
        # Pattern: GPS coordinates exist but timestamps are null/stale
      - "device_config_wrong.yaml"
        # Pattern: Device mapped incorrectly or ELD config incomplete
      - "carrier_not_configured.yaml"
        # Pattern: Carrier exists but not configured for tracking
      - "late_assignment.yaml"
        # Pattern: Load assigned to carrier after significant delay
      - "stale_location.yaml"
        # Pattern: Last position update is hours/days old
      - "callback_failure.yaml"
        # Pattern: Updates processed but callbacks not delivered

  # Confidence Thresholds
  confidence_thresholds:
    auto_resolve: 0.90
      # Confidence >= 90% → Auto-determine root cause, present with high confidence
    human_review: 0.80
      # 80-90% → Present findings with recommendation, suggest next steps
    escalate: 0.50
      # < 50% → Present evidence gathered, escalate to human analyst

  # Human Handoff Triggers
  human_handoff:
    triggers:

      low_confidence:
        threshold: 0.7
        action: "Present findings and ask human to verify"
        message: |
          I've gathered data but confidence is low.

          Evidence collected:
          - Platform check: {platform_result}
          - ELD config: {eld_config_result}
          - Network relationship: {network_result}

          What should I check next?

      stuck_after_steps:
        max_steps: 6
        action: "Present timeline and ask for guidance"
        message: |
          I've checked:
          - Platform: {platform_result}
          - ELD Config: {eld_result}
          - Network Relationship: {network_result}
          - Carrier API: {api_result}
          - SigNoz Logs: {logs_result}

          Still couldn't determine root cause definitively.
          What else should I investigate?

      contradictory_data:
        action: "Ask human to resolve contradiction"
        message: |
          Data sources don't agree:
          - Platform shows tracking enabled: {platform_enabled}
          - ELD config shows ELD disabled: {eld_disabled}
          - Network relationship is {network_status}

          Which source should I trust?

      critical_decision:
        actions:
          - "create_network_relationship"
          - "enable_eld_tracking"
          - "escalate_to_carrier"
          - "escalate_to_engineering"
        action: "Get human approval before proceeding with critical actions"
        message: |
          Root cause identified: {root_cause}
          Recommended action: {action}

          This will {impact_description}

          Should I proceed? [Yes] [No] [Modify]

  # Output Format
  output_format:
    type: "investigation_result"
    fields:

      - name: "root_cause"
        type: "string"
        enum:
          - "eld_not_enabled"
          - "eld_offline"
          - "network_relationship_missing"
          - "network_relationship_inactive"
          - "carrier_not_configured"
          - "carrier_api_down"
          - "carrier_api_auth_failed"
          - "device_misconfigured"
          - "late_assignment"
          - "gps_data_invalid"
          - "gps_timestamps_stale"
          - "callback_delivery_failed"
          - "callback_endpoint_unreachable"
          - "processing_error"
          - "system_bug"
          - "unknown"
        description: "Specific root cause identified"

      - name: "root_cause_category"
        type: "string"
        enum:
          - "configuration_issue"
          - "carrier_issue"
          - "network_issue"
          - "device_issue"
          - "system_bug"
          - "customer_issue"
        description: "High-level category of root cause"

      - name: "issue_scope"
        type: "string"
        enum:
          - "single_load"
          - "carrier_wide"
          - "shipper_wide"
          - "system_wide"
        description: "How many loads/shipments affected"

      - name: "evidence"
        type: "array"
        items:
          type: "object"
          fields:
            - name: "source"
              type: "string"
              description: "Where evidence came from (platform, api, logs, db)"
            - name: "finding"
              type: "string"
              description: "What was found"
            - name: "timestamp"
              type: "string"
              format: "iso8601"
              description: "When the evidence was collected"
            - name: "confidence"
              type: "float"
              min: 0.0
              max: 1.0
        description: "Evidence supporting root cause"

      - name: "confidence_score"
        type: "float"
        min: 0.0
        max: 1.0
        description: "Overall confidence in root cause determination (0-1)"

      - name: "recommended_action"
        type: "object"
        fields:
          - name: "action"
            type: "string"
            enum:
              - "enable_eld"
              - "restart_device"
              - "restart_eld_sync"
              - "create_network_relationship"
              - "activate_network_relationship"
              - "configure_carrier"
              - "contact_carrier"
              - "update_device_config"
              - "reprocess_load"
              - "escalate_to_carrier"
              - "escalate_to_engineering"
              - "customer_communication_only"
            description: "Recommended action to fix issue"
          - name: "priority"
            type: "string"
            enum:
              - "critical"
              - "high"
              - "medium"
              - "low"
            description: "Urgency of recommended action"
          - name: "assignee"
            type: "string"
            description: "Who should take the action"
          - name: "human_approval_required"
            type: "boolean"
            description: "Does action require human review before execution?"

      - name: "time_to_investigate"
        type: "string"
        format: "duration"
        description: "Total time spent on investigation"

      - name: "steps_completed"
        type: "array"
        items:
          type: "object"
          fields:
            - name: "step_name"
              type: "string"
            - name: "result"
              type: "string"
            - name: "duration"
              type: "string"
              format: "duration"

      - name: "escalation"
        type: "object"
        fields:
          - name: "needed"
            type: "boolean"
            description: "Is escalation needed?"
          - name: "type"
            type: "string"
            enum:
              - "carrier_contact"
              - "engineering_bug"
              - "device_issue"
              - "integration_issue"
            description: "Type of escalation"
          - name: "ticket_template"
            type: "string"
            description: "Which template to use for escalation"

      - name: "next_steps"
        type: "array"
        items:
          type: "string"
        description: "Suggested follow-up actions or investigations"

  # Metrics to Track
  metrics:

    baseline:
      time: "20-30 minutes"
      tools_used: "4-6"
      data_gathering_time: "75%"
      analysis_time: "25%"
      manual_correlation: "high"

    target:
      time: "8-12 minutes"
      accuracy: "85%"
      human_handoff_rate: "15-20%"
      automation_rate: "60%"
      tools_used: "2-3"

    track:
      - "time_to_complete"
      - "steps_executed"
      - "api_calls_made"
      - "log_queries_executed"
      - "correct_root_cause"
      - "human_handoffs"
      - "escalations"
      - "user_satisfaction"
      - "false_positives"
      - "false_negatives"

  # Integration Points
  integration_points:
    cassie:
      enabled: true
      purpose: "Carrier lookup, network mapping"
    foursight:
      enabled: true
      purpose: "Load patterns, anomaly detection"
    mcp_servers:
      - "tracking_api"
      - "company_api"
      - "signoz_api"
      - "redshift_connector"

  # Test Cases
  test_cases:
    location: "./test_cases/"
    count: 20
    categories:
      eld_issues: 5
      network_issues: 4
      carrier_issues: 4
      gps_issues: 3
      callback_issues: 2
      system_issues: 2

  # Domain Knowledge References
  knowledge_base:
    path: "knowledge_base.md"
    sources:
      - "PRASHANT_SESSION_PREP.md"
      - "SUPPORT-TEAM-MENTAL-MODEL.md"
      - "SUPPORT-SKILLS-AND-TOOLS-CATALOG.md"
      - "Confluence: Carrier OTR Configuration Guide"
      - "Confluence: ELD Integration Requirements"
      - "Confluence: OTR Troubleshooting Workflows"

  # Related Skills (for multi-skill investigations)
  related_skills:
    - "ocean_debugging"
      # May need to check if ocean mode involved
    - "callbacks_analytics"
      # For callback-specific issues

  # Version History
  version_history:
    - version: "1.0.0"
      date: "2026-01-14"
      status: "initial-poc"
      description: "Initial POC based on Prashant session prep"
      author: "MSP Raja"

---
# Metadata Section

metadata:
  icon: "truck"
  color: "#4A90E2"
  tags:
    - "otr"
    - "ground"
    - "tracking"
    - "root-cause-analysis"
    - "support-operations"
    - "eld"
    - "device-integration"

  documentation:
    user_guide: "USER_GUIDE.md"
    api_reference: "API_REFERENCE.md"
    troubleshooting: "TROUBLESHOOTING.md"
    examples: "EXAMPLES.md"

  sla:
    target_resolution_time: "15 minutes"
    automation_potential: "high"
    requires_human_review: true

  support:
    owner: "MSP Raja, AI R&D Solutions Engineer"
    slack_channel: "#ai-rca-support"
    contact: "msps@fourkites.com"
