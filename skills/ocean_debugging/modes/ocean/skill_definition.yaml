# Ocean Debugging Skill Definition
# Based on: Support Team Mental Model (Surya's workflow - Jan 7, 2026)
# Source: SUPPORT-TEAM-MENTAL-MODEL.md, Support-Troubleshooting-Mind-Map.html

skill:
  id: "ocean_debugging"
  name: "Ocean Shipment Debugging"
  version: "1.0.0"
  owner: "Surya (Support Analyst - ISBO Team)"
  status: "poc"
  created: "2026-01-13"

  description: |
    Debug ocean shipment tracking issues using support team's proven mental model.
    Follows multi-source triangulation approach: Platform -> API -> JT Portal -> SigNoz logs.

    Primary Issue Types Handled:
    - Load not tracking (Awaiting Tracking Info) - 35% of tickets
    - Wrong vessel departure dates
    - Missing milestones (VD, AG, ET events)
    - ETA discrepancies - 20% of tickets
    - Data source conflicts (JT vs EDI vs API)

    Mental Model: "Triangulate across multiple sources to find ground truth"

  # When Router Should Invoke This Skill
  triggers:
    keywords:
      - "not tracking"
      - "awaiting tracking info"
      - "vessel departure"
      - "wrong date"
      - "ocean"
      - "container"
      - "booking"
      - "bill of lading"
      - "VD"  # Vessel Departure
      - "AG"  # Arrived Gate
      - "ET"  # Estimated Time
      - "milestone"
      - "JT"
      - "just transform"
      - "scraping"
      - "rollover"

    issue_categories:
      - "load_not_tracking"
      - "eta_issues"
      - "milestone_wrong"
      - "milestone_missing"
      - "data_source_conflict"

    conditions:
      - "load.mode == 'OCEAN'"
      - "load.mode == 'INTERMODAL' AND segment.mode == 'OCEAN'"

  # What This Skill Can Do (Capabilities from Mental Model)
  capabilities:

    - id: "platform_check"
      name: "Platform Check (Customer View)"
      description: |
        First look - see what customer sees.
        Check load existence, current state, tracking method, source of update.
      confidence: "high"
      time_estimate: "2-3 minutes"
      tools:
        - "fourkites_platform"
      outputs:
        - "load_exists"
        - "current_state"
        - "tracking_method"
        - "update_source"  # RPA, API, EDI, Vessel

    - id: "get_tracking_config"
      name: "Get Tracking Configuration"
      description: |
        Get subscription and tracking details from Super API.
        Identifies primary tracking identifier and JT subscription ID.
      confidence: "high"
      time_estimate: "1-2 minutes"
      tools:
        - "super_api"
        - "tracking_api"
      outputs:
        - "primary_identifier"  # booking_number, bill_of_lading, container
        - "subscription_id"
        - "tracking_source"

    - id: "check_justtransform"
      name: "Check Just Transform (JT) Portal"
      description: |
        See exactly what was scraped from carrier portal.
        Compare crawled output vs formatted response.
      confidence: "medium"
      time_estimate: "10-15 minutes"
      tools:
        - "justtransform_api"
      outputs:
        - "crawled_events"
        - "formatted_response"
        - "event_codes"  # VD, AG, ET
        - "timestamps"
        - "locations"

    - id: "analyze_signoz_logs"
      name: "Deep Dive into SigNoz Logs"
      description: |
        See what system actually processed.
        Query multimodel_carrier_updates_worker logs.
      confidence: "medium"
      time_estimate: "15-20 minutes"  # Most time-consuming
      tools:
        - "signoz_clickhouse"
      outputs:
        - "processed_events"
        - "event_codes"
        - "correlation_ids"
        - "data_sources"
        - "duplicates"
        - "corrections"

    - id: "correlate_findings"
      name: "Correlate Findings Across Sources"
      description: |
        Manual correlation across Platform, JT, SigNoz, API.
        Identify discrepancies and patterns.
      confidence: "high"
      time_estimate: "5-10 minutes"
      tools:
        - "correlation_engine"
      outputs:
        - "timeline"
        - "discrepancies"
        - "pattern_match"

  # Data Sources (from Support Tools Catalog)
  data_sources:

    platform:
      name: "FourKites Platform"
      type: "web_ui"
      purpose: "Customer view - first look"
      auth: "user_login"
      data_available:
        - "load_details"
        - "all_milestones"
        - "stop_information"
        - "tracking_method"
        - "update_source"

    super_api:
      name: "Super API"
      type: "rest_api"
      endpoint: "${SUPER_API_URL}"
      auth: "api_key"
      credentials: "env:SUPER_API_KEY"
      purpose: "Get tracking config, subscription details"
      data_available:
        - "tracking_id"
        - "primary_identifier"
        - "subscription_id"
        - "tracking_source"

    tracking_api:
      name: "Tracking API"
      type: "rest_api"
      endpoint: "${TRACKING_API_URL}"
      auth: "api_key"
      credentials: "env:TRACKING_API_KEY"
      purpose: "Load metadata and real-time tracking"

    justtransform:
      name: "Just Transform Portal/API"
      type: "rest_api"
      endpoint: "${JT_API_URL}"
      auth: "basic"
      credentials: "env:JT_USERNAME,JT_PASSWORD"
      purpose: "Web scraping data - crawled output vs response"
      latency: "~6 hours"
      carriers_supported: "60-70"
      data_available:
        - "subscription_history"
        - "crawled_output"
        - "formatted_response"
        - "event_codes"

    signoz:
      name: "SigNoz (ClickHouse Logs)"
      type: "log_analytics"
      service: "signoz"
      auth: "user_login"
      credentials: "env:SIGNOZ_TOKEN"
      purpose: "Deep dive into processing logs"
      retention: "30 days"
      query_service: "multimodel_carrier_updates_worker"
      query_keyword: "PROCESS_OCEAN_UPDATE"

    redshift:
      name: "Redshift DWH"
      type: "database"
      auth: "aws_iam"
      tables:
        - "company_relationships"  # THE MOST CRITICAL TABLE
        - "fact_carrier_file_logs"
        - "fact_carrier_record_logs"
        - "load_validation_data_mart"
        - "tracking_update_v3s"

    data_hub:
      name: "Data Hub API"
      type: "rest_api"
      purpose: "Ocean-specific troubleshooting (basic data)"
      auth: "user_login"
      status: "production"

    s3:
      name: "AWS S3"
      type: "file_storage"
      purpose: "EDI file backups (EA315, 214)"
      auth: "aws_cli"

  # Decision Tree Reference
  decision_tree:
    path: "decision_tree.yaml"
    entry_point: "step_1_platform_check"

  # Human Handoff Triggers (from Mental Model)
  human_handoff:
    triggers:

      low_confidence:
        threshold: 0.7
        action: "Present findings and ask human to verify"
        message: |
          I've gathered data but confidence is low.
          Here's what I found: {findings}
          What should I check next?

      stuck_after_steps:
        max_steps: 5
        action: "Present timeline and ask for guidance"
        message: |
          I've checked:
          - Platform: {platform_result}
          - JT: {jt_result}
          - SigNoz: {signoz_result}

          Still couldn't determine root cause.
          What else should I look at?

      contradictory_data:
        action: "Ask human to resolve contradiction"
        message: |
          Data sources don't agree:
          - Platform shows: {platform_data}
          - JT shows: {jt_data}
          - SigNoz shows: {signoz_data}

          Which source should I trust?

      critical_decision:
        actions:
          - "create_relationship"
          - "escalate_to_engineering"
          - "escalate_to_jt_team"
          - "contact_carrier"
        action: "Get human approval before proceeding"
        message: |
          Root cause identified: {root_cause}
          Recommended action: {action}

          Should I proceed? [Yes] [No] [Modify]

  # Output Format
  output_format:
    type: "investigation_result"
    fields:
      - name: "root_cause"
        type: "string"
        enum:
          - "network_relationship_missing"
          - "network_relationship_inactive"
          - "carrier_not_sending_files"
          - "file_matching_failed"
          - "jt_scraping_error"
          - "carrier_portal_wrong_data"
          - "configuration_issue"
          - "system_bug"
          - "unknown"

      - name: "root_cause_category"
        type: "string"
        enum:
          - "carrier_issue"
          - "jt_issue"
          - "configuration_issue"
          - "system_bug"

      - name: "evidence"
        type: "array"
        items:
          - "source"
          - "finding"
          - "timestamp"

      - name: "confidence_score"
        type: "float"
        min: 0.0
        max: 1.0

      - name: "recommended_action"
        type: "object"
        fields:
          - "action"
          - "priority"
          - "assignee"
          - "human_approval_required"

      - name: "time_to_investigate"
        type: "duration"

      - name: "steps_completed"
        type: "array"

      - name: "escalation"
        type: "object"
        fields:
          - "needed"
          - "type"  # jt_bug, engineering_bug, carrier_contact
          - "ticket_template"

  # Metrics to Track
  metrics:
    baseline:
      time: "30-45 minutes"
      tools_used: "5-8"
      data_gathering_time: "80%"
      analysis_time: "20%"

    target:
      time: "10-15 minutes"
      accuracy: "85%"
      human_handoff_rate: "15%"

    track:
      - "time_to_complete"
      - "steps_executed"
      - "api_calls_made"
      - "correct_root_cause"
      - "human_handoffs"
      - "user_satisfaction"

  # Domain Knowledge References
  knowledge_base:
    path: "knowledge_base.md"
    sources:
      - "SUPPORT-TEAM-MENTAL-MODEL.md"
      - "SUPPORT-SKILLS-AND-TOOLS-CATALOG.md"
      - "Support-Troubleshooting-Mind-Map.html"
      - "Confluence: Carrier List"
      - "Confluence: Load Not Tracking Workflow"
      - "Confluence: EDI Format Specs"
